name: CI/CD
# pasen la tarea
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    name: Build Docker images
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build backend and frontend images
        run: docker compose -f docker-compose.yml build backend frontend

  deploy:
    name: Deploy to production
    needs: build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    environment:
      name: production

    steps:
      - name: Dump runner context
        run: |
          set -euxo pipefail
          echo "Runner hostname: $(hostname)"
          echo "Runner public IP: $(curl -fsS https://api.ipify.org || echo unknown)"
          ip addr
          ip route

      - name: Check SSH reachability
        run: |
          set -euxo pipefail
          # Using provided IP
          TARGET_HOST="161.132.24.2"
          TARGET_PORT="22"
          
          sudo apt-get update -y
          sudo apt-get install -y netcat-openbsd traceroute
          nc -vz -w 5 "$TARGET_HOST" "$TARGET_PORT"
          traceroute -n "$TARGET_HOST" || true

      - name: Deploy over SSH
        uses: appleboy/ssh-action@v1.0.1
        with:
          host: "161.132.24.2"
          username: "developer"
          password: "1n6TKMfybg5GdR3U"
          port: 22
          # key: ${{ secrets.SSH_PRIVATE_KEY }} # Using password as requested
          script: |
            set -euo pipefail
            
            # Navigate to deploy path (assuming it is set in secrets or fixed path, defaulting to user home for safety if secret missing)
            # WORKAROUND: If DEPLOY_PATH is not set, we need a fallback. 
            # Assuming standard path or relying on secret if valid. 
            # User didn't provide path, but previous yaml used secrets.DEPLOY_PATH. 
            # We will keep using the secret for path, assuming it is correct or user will fix valid path.
            TARGET_PATH="${{ secrets.DEPLOY_PATH }}"
            if [ -z "$TARGET_PATH" ]; then
              TARGET_PATH="/home/developer/plataforma_pide" # Fallback guess or error out
            fi
            
            cd "$TARGET_PATH"
            
            # Ensure we are on the right branch
            git fetch ci-cd main
            git reset --hard ci-cd/main
            
            docker compose pull || true
            docker compose down
            docker compose up -d --build --remove-orphans
            docker image prune -f
          debug: true
